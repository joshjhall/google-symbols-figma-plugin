# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Figma plugin that generates and maintains a complete Google Material Symbols library (4000+ icons) using variable fonts. The plugin automatically syncs with Google's Material Design Icons repository and supports intelligent incremental updates.

## Development Commands

### Essential Commands

- `pnpm install` - Install dependencies (uses pnpm, not npm)
- `pnpm build` - Production build (builds both code and UI)
- `pnpm dev` - Development watch mode (runs code and UI builds concurrently)
- `pnpm test` - Run tests with Vitest
- `pnpm test:watch` - Run tests in watch mode
- `pnpm typecheck` - Run TypeScript type checking
- `pnpm lint` - Lint code with ESLint
- `pnpm lint:fix` - Fix linting issues automatically
- `pnpm format` - Format code with Prettier

### Build Components

- `pnpm build:code` - Build plugin code only (src/code.ts → dist/code.js)
- `pnpm build:ui` - Build UI only (src/ui.tsx → dist/ui.js + dist/ui.html)
- `pnpm clean` - Remove dist directory

### Icon Management Scripts

- `pnpm icons:update` - Fetch latest icon list from Google's GitHub repo (Phase 1)
- `pnpm icons:compare` - Generate comparison delta between commits (Phase 2)

## Architecture Overview

### Plugin Structure

The plugin follows a **two-process architecture** (Figma's plugin model):

1. **Main Plugin Code** (`src/code.ts`): Runs in Figma's main thread with access to the Figma API
2. **UI Code** (`src/ui.tsx`): Runs in an iframe with React, communicates via `postMessage`

### Message-Based Communication

All communication between UI and plugin happens through a message bus defined in `src/types.ts` using the `PLUGIN_MESSAGES` enum. The plugin code routes messages in `src/code.ts` to appropriate handlers.

### Key Architectural Components

#### 1. Icon Generation Pipeline

**Category-Based Generation** (`src/handlers/category-generation.ts`):

- Icons are organized into alphabetical categories (e.g., "Set 1: 10k-add_chart")
- Each category generates **504 variants per icon** (7 styles × 6 weights × 4 fills × 3 grades × 4 sizes)
- Uses intelligent update logic with metadata comparison (commit SHA + content hash)
- Supports incremental updates (only changed variants)

**Smart Update Logic**:

- Skips unchanged icons using commit SHA and variant count checks
- Content hash comparison detects actual SVG changes
- Cumulative change tracking supports version skipping (e.g., v1 → v3 without v2)
- Delta files: `icon-changes.json` and `icon-changes-cumulative.json`

#### 2. Icon Sources and Versioning

**Commit-Based Versioning**:

- The plugin pins to a specific commit SHA from Google's material-design-icons repo
- Commit SHA is stored in `src/lib/icons/icon-list-metadata.json`
- All SVG URLs use this SHA to ensure consistency between icon list and fetched files
- Set via `setGitHubRef(COMMIT_SHA)` in `src/code.ts`

**Icon Data Flow**:

1. `scripts/update-icon-list.ts` - Fetches icon list from GitHub (SINGLE SOURCE OF TRUTH)
2. Generates `src/lib/icons/all-icons-data.json` and `icon-list-metadata.json`
3. `scripts/compare-and-generate.ts` - Compares commits and generates delta files
4. Plugin runtime uses these files for generation

#### 3. Core Modules

**`src/lib/icons/`** - Icon generation and management

- `batch-generator.ts` - Batch processing with layout and progress tracking
- `incremental-updater.ts` - Updates only changed variants (minimizes version bloat)
- `component-factory.ts` - Creates Figma component sets from SVG data
- `variant-utils.ts` / `variant-formatter.ts` - Variant property handling

**`src/lib/github/`** - GitHub API integration

- `api.ts` - Fetches SVG files from material-design-icons repo
- `url-generator.ts` - Generates GitHub raw URLs with commit SHA

**`src/lib/tokens/`** - Material Design 3 token system

- Variable bindings for weight, fill, grade, optical size
- Resolves and applies Figma variables to components

**`src/lib/pages/`** - Page organization

- `manager.ts` - Handles category-based page structure

**`src/handlers/`** - Message handlers for plugin operations

- `category-generation.ts` - Main generation orchestration
- `page-organization.ts` - Page setup and layout
- Rate limiting with exponential backoff (handles GitHub 429 responses)

#### 4. Rate Limiting

GitHub API rate limits are handled with exponential backoff:

- Detection: 429 HTTP responses
- Retry delays: 1min → 2min → 4min → 8min → 10min (max)
- See `src/handlers/category-generation/rate-limiter.ts`

### Data Files Generated by Scripts

- `src/lib/icons/all-icons-data.json` - Complete icon list (RUNTIME)
- `src/lib/icons/icon-list-metadata.json` - Commit SHA metadata
- `icon-changes.json` - Direct delta between two commits (OPTIONAL)
- `icon-changes-cumulative.json` - Cumulative changes across multiple commits (OPTIONAL)
- `category-mapping.json` - Maps icons to alphabetical categories

## Development Workflow

### Testing in Figma

1. Run `pnpm dev` to start watch mode
2. In Figma Desktop: **Plugins → Development → Import plugin from manifest**
3. Select `manifest.json` from the project root
4. Run plugin from **Plugins → Material Icons Generator**
5. Changes to code/UI auto-rebuild; click "Reload" in Figma to test

### Icon Update Process

When Google releases new Material Symbols:

1. **Fetch new icon list**: `pnpm icons:update --ref=master`
2. **Generate delta**: `pnpm icons:compare`
3. **Rebuild plugin**: `pnpm build`
4. The plugin will now use the new commit SHA and delta files

### Commit Convention

This project uses **Conventional Commits** enforced by commitlint:

- `feat:` - New features
- `fix:` - Bug fixes
- `docs:` - Documentation changes
- `chore:` - Maintenance tasks
- `test:` - Test changes
- `refactor:` - Code refactoring

Commits are validated via Husky pre-commit hooks.

## Important Technical Details

### Figma API Constraints

- **504 variants per icon**: Each icon has 7 styles × 6 weights × 4 fills × 3 grades × 4 sizes
- **Component Sets**: Icons are created as ComponentSetNodes with variant properties
- **Performance**: Generating 4000+ icons takes 10-15 minutes with delta, 3-4 hours without
- **Rate Limiting**: Plugin auto-retries with exponential backoff for GitHub API limits

### TypeScript Configuration

- Path aliases configured in `tsconfig.json`:
  - `@/*` → `src/*`
  - `@lib/*` → `src/lib/*`
  - `@utils/*` → `src/utils/*`
- Target: ES2017 for plugin code, Chrome 58 for UI
- Strict mode enabled

### Build System

- **esbuild** for fast bundling
- Plugin code and UI built separately
- HTML generation via `scripts/build-html.js` (inlines UI.js into ui.html)
- No source maps in production builds (use `build:dev` for debugging)

### Testing

- **Vitest** for unit tests
- Mocks for Figma API in `src/__tests__/mocks/figma-api.mock.ts`
- Coverage available via `pnpm test:coverage`

## Common Gotchas

1. **Always use pnpm**: The project uses pnpm (not npm or yarn) - package manager is locked in package.json
2. **Two separate build processes**: Plugin code and UI are bundled independently
3. **Message passing**: UI and plugin communicate via postMessage only - no shared state
4. **Commit SHA is critical**: All icon URLs must use the same commit SHA as the icon list
5. **Delta files are optional**: Plugin works without them, but updates are much slower
6. **Rate limiting is real**: Respect GitHub API limits; the plugin handles retries automatically
7. **Variant count matters**: When updating icons, the plugin checks variant count to detect structural changes

## Security Note

The file `src/lib/message-handler.ts:10` contains a hardcoded GitHub token. This should be removed or moved to environment variables before any public release.
